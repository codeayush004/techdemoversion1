name: Dockerfile Optimizer Gate

on:
  pull_request:
    paths:
      - '**/Dockerfile*'

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install requests

      - name: Run Optimizer Scan
        id: scan
        continue-on-error: true
        env:
          OPTIMIZER_SERVER: ${{ secrets.OPTIMIZER_API_URL || 'https://your-optimizer-api.com/api' }}
        run: |
          python3 bin/optimizer-cli.py --file Dockerfile --server "$OPTIMIZER_SERVER" --json > scan_result.json
          echo "scan_exit_code=$?" >> $GITHUB_ENV

      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = JSON.parse(fs.readFileSync('scan_result.json', 'utf8'));
            const findings = result.findings || [];
            
            let comment = `### üèôÔ∏è Docker Optimizer Analysis\n\n`;
            
            if (findings.length === 0) {
              comment += `‚úÖ **No issues found!** Your Dockerfile follows best practices.\n`;
            } else {
              comment += `‚ö†Ô∏è **Found ${findings.length} optimization opportunities.**\n\n`;
              comment += `| Severity | Finding | Recommendation |\n`;
              comment += `| :--- | :--- | :--- |\n`;
              findings.forEach(f => {
                const icon = f.severity === 'CRITICAL' ? 'üî¥' : f.severity === 'HIGH' ? 'üü†' : 'üü°';
                comment += `| ${icon} ${f.severity} | ${f.message} | ${f.recommendation || '-'} |\n`;
              });
              
              comment += `\n---\n\n`;
              comment += `### ‚ú® Optimized Dockerfile Preview\n`;
              comment += `> [!TIP]\n`;
              comment += `> Review the AI-generated optimization below. To accept these changes, run \`ag-ci apply\` or copy-paste into your Dockerfile.\n\n`;
              
              const opt = result.recommendation?.optimized_dockerfile || "Optimization unavailable.";
              comment += "```dockerfile\n" + opt + "\n```\n";
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Interpret Labels and Build
        run: |
          LABELS=$(jq -r '.[].name' <<EOF
          ${{ toJson(github.event.pull_request.labels) }}
          EOF
          )
          
          if echo "$LABELS" | grep -q "‚ú® use-optimized"; then
            echo "‚úÖ Permission Granted: Using Optimized Dockerfile."
            python3 bin/optimizer-cli.py --file Dockerfile --server "${{ secrets.OPTIMIZER_API_URL }}" --apply
            echo "BUILD_SOURCE=OPTIMIZED" >> $GITHUB_ENV
          elif echo "$LABELS" | grep -q "üê¢ use-original"; then
            echo "‚ö†Ô∏è Permission Granted: Using Original Dockerfile (User Override)."
            echo "BUILD_SOURCE=ORIGINAL" >> $GITHUB_ENV
          else
            echo "‚õî Permission Required! Please add a label: '‚ú® use-optimized' or 'üê¢ use-original' to proceed."
            exit 1
          fi

      - name: Build Docker Image
        run: |
          echo "Building with $BUILD_SOURCE version..."
          docker build . -t my-app:latest
